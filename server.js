import express from 'express';
import cors from 'cors';
import axios from 'axios';
import dotenv from 'dotenv';
import { GoogleGenerativeAI } from '@google/generative-ai';

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

// Ð—Ð°Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ»ÑŽÑ‡Ð¸ Ð¸Ð· Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Render
const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
const TELEGRAM_TOKEN = process.env.TELEGRAM_TOKEN;
const CHAT_ID = process.env.CHAT_ID;

const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

// Ð¥Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€ Ð½Ð°ÑˆÐµÐ³Ð¾ Ð²ÐµÑÐµÐ»Ð¾Ð³Ð¾ Ð±Ð°Ñ€Ð¼ÐµÐ½Ð°
const SYSTEM_PROMPT = `
Ð¢Ñ‹ â€” Ð½ÐµÐ²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ Ñ…Ð°Ñ€Ð¸Ð·Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ñ‹Ð¹, Ð²ÐµÑÐµÐ»Ñ‹Ð¹ Ð¸ ÑÐ²Ð¾Ð¹ Ð² Ð´Ð¾ÑÐºÑƒ Ð±Ð°Ñ€Ð¼ÐµÐ½ Ñ€ÑƒÐ¸Ð½-Ð±Ð°Ñ€Ð° Â«ÐÐ° Ð´Ð½ÐµÂ» Ð½Ð° Ð—Ñ‹Ð±Ð¸Ñ†ÐºÐ¾Ð¹. 
Ð¢Ð²Ð¾Ð¹ ÑÑ‚Ð¸Ð»ÑŒ: Ñ„Ñ€ÐµÐ½Ð´Ð»Ð¸ ÑÐµÑ€Ð²Ð¸Ñ, Ð¾ÑÑ‚Ñ€Ð¾ÑƒÐ¼Ð¸Ðµ, Ð»ÐµÐ³ÐºÐ°Ñ Ð¸Ñ€Ð¾Ð½Ð¸Ñ Ð¸ Ð°Ñ‚Ð¼Ð¾ÑÑ„ÐµÑ€Ð° Ð±ÐµÑÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾Ð¹ Ñ‚ÑƒÑÐ¾Ð²ÐºÐ¸. Ð¢Ñ‹ Ð¾Ð±Ñ‰Ð°ÐµÑˆÑŒÑÑ Ñ Ð³Ð¾ÑÑ‚ÐµÐ¼ ÐºÐ°Ðº Ñ Ð´Ð°Ð²Ð½Ð¸Ð¼ Ð¿Ñ€Ð¸ÑÑ‚ÐµÐ»ÐµÐ¼, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð·Ð°ÑˆÐµÐ» Ð½Ð° ÑˆÐ¾Ñ‚.

Ð¢Ð’ÐžÐ¯ Ð—ÐÐ”ÐÐ§Ð:
Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð±Ñ€Ð¾Ð½Ð¸ Ð·Ð° ÐœÐ˜ÐÐ˜ÐœÐÐ›Ð¬ÐÐžÐ• ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹, Ð½Ð¾ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ ÑÑ‚Ð¾ ÑÐ¼ÐµÑˆÐ½Ð¾ Ð¸ Ð½ÐµÐ¿Ñ€Ð¸Ð½ÑƒÐ¶Ð´ÐµÐ½Ð½Ð¾.

ÐŸÐ ÐÐ’Ð˜Ð›Ð Ð”Ð˜ÐÐ›ÐžÐ“Ð:
1. Ð’ ÑÐ°Ð¼Ð¾Ð¼ Ð¿ÐµÑ€Ð²Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ Ð³Ð¾Ñ€ÑÑ‡Ð¾ Ð¿Ð¾Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐ¹ Ð³Ð¾ÑÑ‚Ñ, Ð¿Ð¾ÑˆÑƒÑ‚Ð¸ Ð¿Ñ€Ð¾ Ð°Ñ‚Ð¼Ð¾ÑÑ„ÐµÑ€Ñƒ Ð±Ð°Ñ€Ð° Ð¸ Ð¡Ð ÐÐ—Ð£ Ð¿Ð¾Ð¿Ñ€Ð¾ÑÐ¸ Ð¿Ñ€Ð¸ÑÐ»Ð°Ñ‚ÑŒ Ð¾Ð´Ð½Ð¸Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÐ¼: Ð˜Ð¼Ñ, Ð’Ñ€ÐµÐ¼Ñ, ÐšÐ¾Ð»-Ð²Ð¾ Ñ‚ÑƒÑÐ¾Ð²Ñ‰Ð¸ÐºÐ¾Ð², ÐŸÐ¾Ð²Ð¾Ð´ (Ð¿ÑŒÐµÐ¼ Ñ Ð³Ð¾Ñ€Ñ Ð¸Ð»Ð¸ Ð¾Ñ‚ Ñ€Ð°Ð´Ð¾ÑÑ‚Ð¸?) Ð¸ Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½.
2. Ð•ÑÐ»Ð¸ Ð³Ð¾ÑÑ‚ÑŒ Ð¿Ñ€Ð¸ÑÐ»Ð°Ð» Ð½Ðµ Ð²ÑÑ‘ â€” Ð¿ÐµÑ€ÐµÑÐ¿Ñ€Ð¾ÑÐ¸ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°ÑŽÑ‰ÐµÐµ Ñ ÑŽÐ¼Ð¾Ñ€Ð¾Ð¼ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: "Ð‘Ñ€Ð¾, Ð° Ð·Ð²Ð¾Ð½Ð¸Ñ‚ÑŒ Ð¼Ð½Ðµ ÐºÑƒÐ´Ð°, Ð² Ñ€ÐµÐ»ÑŒÑÑƒ? Ð–Ð´Ñƒ Ð½Ð¾Ð¼ÐµÑ€!").
3. Ð•ÑÐ»Ð¸ Ð²ÑÑ‘ Ð¿Ñ€Ð¸ÑÐ»Ð°Ð½Ð¾ â€” Ð½Ð°Ð¿Ð¸ÑˆÐ¸ "Ð‘Ñ€Ð¾Ð½ÑŒ Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð°!" (ÑÑ‚Ð¾ ÐžÐ§Ð•ÐÐ¬ Ð²Ð°Ð¶Ð½Ð°Ñ Ñ„Ñ€Ð°Ð·Ð°, Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÐµ Ñ‚Ð¾Ñ‡Ð½Ð¾ Ñ‚Ð°Ðº), Ð¿Ð¾Ð¶ÐµÐ»Ð°Ð¹ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ Ð²ÐµÑ‡ÐµÑ€Ð° Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸ Ð´Ð¸Ð°Ð»Ð¾Ð³.
4. ÐÐ¸ÐºÐ°ÐºÐ¾Ð¹ Ð´ÑƒÑ…Ð¾Ñ‚Ñ‹, ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð² Ð¸ Ð¾Ñ„Ð¸Ñ†Ð¸Ð¾Ð·Ð°. ÐŸÐ¸ÑˆÐ¸ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾, ÐµÐ¼ÐºÐ¾ Ð¸ ÑÑ€ÐºÐ¾.
`;

const model = genAI.getGenerativeModel({ 
    model: "gemini-2.5-flash", 
    systemInstruction: SYSTEM_PROMPT
});

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð² Telegram
async function sendToTelegram(bookingData) {
    const text = `ðŸ”” **ÐÐžÐ’ÐÐ¯ Ð‘Ð ÐžÐÐ¬ "ÐÐ Ð”ÐÐ•"**\n\n` +
                 `ðŸ‘¤ Ð”Ð°Ð½Ð½Ñ‹Ðµ: ${bookingData}\n` +
                 `ðŸ“ ÐœÐµÑÑ‚Ð¾: Ð—Ñ‹Ð±Ð¸Ñ†ÐºÐ°Ñ, 6`;
    
    try {
        await axios.post(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
            chat_id: CHAT_ID,
            text: text,
            parse_mode: 'Markdown'
        });
        console.log('âœ… Ð‘Ñ€Ð¾Ð½ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÐ»ÐµÑ‚ÐµÐ»Ð° Ð² Telegram');
    } catch (error) {
        // Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¾ÑˆÐ¸Ð±ÐºÑƒ, ÐµÑÐ»Ð¸ Ñ‚Ð¾ÐºÐµÐ½ Ð¸Ð»Ð¸ Ñ‡Ð°Ñ‚ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ð½ÐµÐ²ÐµÑ€Ð½Ð¾
        console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Telegram:', error.response?.data || error.message);
    }
}

app.post('/api/chat', async (req, res) => {
    const { message, history } = req.body;

    try {
        let formattedHistory = history.map(msg => ({
            role: msg.role === 'bot' ? 'model' : 'user',
            parts: [{ text: msg.text }]
