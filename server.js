import express from 'express';
import cors from 'cors';
import axios from 'axios';
import dotenv from 'dotenv';
import { GoogleGenerativeAI } from '@google/generative-ai';

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

// –ó–∞–±–∏—Ä–∞–µ–º –∫–ª—é—á–∏ –∏–∑ Render
const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
const TELEGRAM_TOKEN = process.env.TELEGRAM_TOKEN;
const CHAT_ID = process.env.CHAT_ID;
const SHEET_URL = process.env.SHEET_URL; // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–≤–æ—é —Ç–∞–±–ª–∏—Ü—É

const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

// –ë–∞–∑–æ–≤—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –±–∞—Ä–º–µ–Ω–∞ –∏ –ø—Ä–∞–≤–∏–ª–∞
const BASE_PROMPT = `
–¢—ã ‚Äî –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π, –≤–µ—Å–µ–ª—ã–π –∏ —Å–≤–æ–π –≤ –¥–æ—Å–∫—É –±–∞—Ä–º–µ–Ω —Ä—É–∏–Ω-–±–∞—Ä–∞ ¬´–ù–∞ –¥–Ω–µ¬ª –Ω–∞ –ó—ã–±–∏—Ü–∫–æ–π. 
–¢–≤–æ–π —Å—Ç–∏–ª—å: —Ñ—Ä–µ–Ω–¥–ª–∏ —Å–µ—Ä–≤–∏—Å, –æ—Å—Ç—Ä–æ—É–º–∏–µ, –ª–µ–≥–∫–∞—è –∏—Ä–æ–Ω–∏—è –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π —Ç—É—Å–æ–≤–∫–∏. –¢—ã –æ–±—â–∞–µ—à—å—Å—è —Å –≥–æ—Å—Ç–µ–º –∫–∞–∫ —Å –¥–∞–≤–Ω–∏–º –ø—Ä–∏—è—Ç–µ–ª–µ–º, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—à–µ–ª –Ω–∞ —à–æ—Ç.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1. –°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±—Ä–æ–Ω–∏ –∑–∞ –ú–ò–ù–ò–ú–ê–õ–¨–ù–û–ï –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π (–ò–º—è, –í—Ä–µ–º—è, –ö–æ–ª-–≤–æ —Ç—É—Å–æ–≤—â–∏–∫–æ–≤, –ü–æ–≤–æ–¥, –¢–µ–ª–µ—Ñ–æ–Ω). –ï—Å–ª–∏ –≤—Å—ë –ø—Ä–∏—Å–ª–∞–Ω–æ ‚Äî –Ω–∞–ø–∏—à–∏ "–ë—Ä–æ–Ω—å –ø—Ä–∏–Ω—è—Ç–∞!".
2. –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –≥–æ—Å—Ç–µ–π –ø—Ä–æ —Ç—É—Å–æ–≤–∫–∏, –¥–∏–¥–∂–µ–µ–≤, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –∞–∫—Ü–∏–∏, –æ–ø–∏—Ä–∞—è—Å—å –¢–û–õ–¨–ö–û –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ —Ç–µ–±–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.

–ü–†–ê–í–ò–õ–ê –î–ò–ê–õ–û–ì–ê:
- –ù–∏–∫–∞–∫–æ–π –¥—É—Ö–æ—Ç—ã –∏ —Å–∫—Ä–∏–ø—Ç–æ–≤. –ü–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ, –µ–º–∫–æ –∏ —è—Ä–∫–æ.
- –ü–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å —é–º–æ—Ä–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ë—Ä–æ, –∞ –∑–≤–æ–Ω–∏—Ç—å –º–Ω–µ –∫—É–¥–∞, –≤ —Ä–µ–ª—å—Å—É? –ñ–¥—É –Ω–æ–º–µ—Ä!").
- –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –∞–∫—Ü–∏–∏, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏–ª–∏ –º—É–∑—ã–∫—É ‚Äî –∑–∞–≥–ª—è–Ω–∏ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —è –ø–µ—Ä–µ–¥–∞–º –Ω–∏–∂–µ, –∏ –≤–µ—Å–µ–ª–æ —Ä–∞—Å—Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –≥–æ—Å—Ç—é. 
- üéß –í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û –ü–†–û –î–ò–î–ñ–ï–ï–í: –í —Ç–∞–±–ª–∏—Ü–µ –¥–∏–¥–∂–µ–∏ –Ω–∞–ø–∏—Å–∞–Ω—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é. –ó–∞–ø–æ–º–Ω–∏ –∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ: –ü–ï–†–í–´–ô –¥–∏–¥–∂–µ–π –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç —Å 22:00 –¥–æ 01:00, –∞ –í–¢–û–†–û–ô –¥–∏–¥–∂–µ–π ‚Äî —Å 01:00 –¥–æ 05:00. –ö–æ–≥–¥–∞ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –≥–æ—Å—Ç—è–º –ø—Ä–æ –º—É–∑—ã–∫—É, –≤—Å–µ–≥–¥–∞ —Å–∞–º —Ä–∞—Å–ø–∏—Å—ã–≤–∞–π —ç—Ç–æ –≤—Ä–µ–º—è!
- –í—ã–¥–∞–≤–∞–π —Ç–æ–ª—å–∫–æ —Ç–æ, –æ —á–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Å–ø—Ä–æ—Å–∏–ª–∏. –ù–µ –≤—ã–≤–∞–ª–∏–≤–∞–π –Ω–∞ –≥–æ—Å—Ç—è –≤—Å—é —Ç–∞–±–ª–∏—Ü—É —Å—Ä–∞–∑—É.
`;

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—Ä–æ–Ω–∏ –≤ Telegram
async function sendToTelegram(bookingData) {
    const text = `üîî **–ù–û–í–ê–Ø –ë–†–û–ù–¨**\n\n` +
                 `üë§ –î–∞–Ω–Ω—ã–µ: ${bookingData}\n` +
                 `üìç –ú–µ—Å—Ç–æ: –®–æ—Ç-–±–∞—Ä –ù–∞ –î–Ω–µ`;
    
    try {
        await axios.post(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
            chat_id: CHAT_ID,
            text: text,
            parse_mode: 'Markdown'
        });
        console.log('‚úÖ –ë—Ä–æ–Ω—å —É—Å–ø–µ—à–Ω–æ —É–ª–µ—Ç–µ–ª–∞ –≤ Telegram');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ Telegram:', error.response?.data || error.message);
    }
}

// "–ë—É–¥–∏–ª—å–Ω–∏–∫" –¥–ª—è Render
app.get('/ping', (req, res) => {
    res.status(200).send('–ë–∞—Ä–º–µ–Ω –Ω–∞ –º–µ—Å—Ç–µ, —Å—Ç–∞–∫–∞–Ω—ã –ø—Ä–æ—Ç–µ—Ä—Ç—ã!');
});

// –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç
app.post('/api/chat', async (req, res) => {
    const { message, history } = req.body;

    try {
        // 1. –°–∫–∞—á–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ—É –∏–∑ –ì—É–≥–ª –¢–∞–±–ª–∏—Ü—ã
        let currentEvents = "–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç, –Ω–æ –º—ã –≤—Å–µ–≥–¥–∞ —Ä–∞–¥—ã –Ω–∞–ª–∏—Ç—å!";
        if (SHEET_URL) {
            try {
                const sheetResponse = await axios.get(SHEET_URL);
                currentEvents = sheetResponse.data;
            } catch (e) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É:", e.message);
            }
        }

        // 2. –°–º–µ—à–∏–≤–∞–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä –±–æ—Ç–∞ –∏ —Å–≤–µ–∂—É—é —Ç–∞–±–ª–∏—Ü—É –≤ –æ–¥–∏–Ω –º–æ–∑–≥
        const fullSystemPrompt = BASE_PROMPT + `\n\n=== –ê–ö–¢–£–ê–õ–¨–ù–û–ï –†–ê–°–ü–ò–°–ê–ù–ò–ï –ò –ê–ö–¶–ò–ò (–ß–ò–¢–ê–ô –û–¢–°–Æ–î–ê) ===\n${currentEvents}`;

        // 3. –ó–∞–ø—É—Å–∫–∞–µ–º –ò–ò —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏
        const model = genAI.getGenerativeModel({ 
            model: "gemini-2.5-flash", 
            systemInstruction: fullSystemPrompt
        });

        // 4. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ–±—â–µ–Ω–∏—è –∏ —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞
        let formattedHistory = history.map(msg => ({
            role: msg.role === 'bot' ? 'model' : 'user',
            parts: [{ text: msg.text }]
        }));

        if (formattedHistory.length > 0 && formattedHistory[0].role === 'model') {
            formattedHistory.shift();
        }

        const chat = model.startChat({
            history: formattedHistory
        });

        // 5. –û—Ç–≤–µ—á–∞–µ–º –≥–æ—Å—Ç—é
        const result = await chat.sendMessage(message);
        const botResponse = result.response.text();

        // 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±—Ä–æ–Ω—å
        if (botResponse.toLowerCase().includes("–±—Ä–æ–Ω—å –ø—Ä–∏–Ω—è—Ç–∞")) {
            await sendToTelegram(message);
        }

        res.json({ text: botResponse });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ Gemini:', error);
        res.status(500).json({ text: '–£–ø—Å, –±–∞—Ä–º–µ–Ω –æ—Ç–≤–ª–µ–∫—Å—è –Ω–∞ –Ω–∞–ª–∏–≤–∫—É. –ü–æ–≤—Ç–æ—Ä–∏-–∫–∞!' });
    }
});

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
    console.log(`‚úÖ –°–µ—Ä–≤–µ—Ä "–ù–∞ –¥–Ω–µ" –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
});
